<div class="min-h-screen bg-slate-50 p-6 lg:p-12">
  <div class="mx-auto max-w-4xl">

    <div class="mb-8 text-center">
      <h1 class="text-3xl font-bold text-slate-900 tracking-tight">Alta de Patrimonio Legal</h1>
      <p class="mt-2 text-slate-600">Completa la infraestructura de tu empresa en una sola operaci贸n at贸mica.</p>
    </div>

    <div class="mb-12 flex items-center justify-between">
      @for (step of [1,2,3,4]; track step) {
      <div class="flex items-center">
        <div [class]="currentStep() >= step 
            ? 'flex h-10 w-10 items-center justify-center rounded-full bg-indigo-600 text-white shadow-lg shadow-indigo-200' 
            : 'flex h-10 w-10 items-center justify-center rounded-full bg-white border-2 border-slate-200 text-slate-400'">
          {{ step }}
        </div>
        @if (step < 4) { 
          <div class="h-1 w-12 sm:w-24 mx-2 rounded bg-slate-200" [class.bg-indigo-600]="currentStep() > step"></div>
        }
      </div>
      }
    </div>

    <div class="rounded-2xl bg-white p-8 shadow-sm border border-slate-100">

      @if (errorMessage()) {
      <div class="mb-6 rounded-lg bg-red-50 p-4 text-sm text-red-700 border border-red-100 animate-in fade-in duration-300">
        {{ errorMessage() }}
      </div>
      }

      @if (currentStep() === 1) {
      <div class="space-y-6 animate-in fade-in duration-500">
        <h2 class="text-xl font-semibold text-slate-800">1. Usuario Responsable (Owner)</h2>
        
        <div class="flex p-1 bg-slate-100 rounded-xl mb-6 border border-slate-200">
          <button (click)="setUserMode('existing')" 
                  [class.bg-white]="userMode() === 'existing'"
                  [class.shadow-sm]="userMode() === 'existing'"
                  class="flex-1 py-2.5 text-sm font-bold rounded-lg transition-all cursor-pointer">
            Seleccionar existente
          </button>
          <button (click)="setUserMode('new')" 
                  [class.bg-white]="userMode() === 'new'"
                  [class.shadow-sm]="userMode() === 'new'"
                  class="flex-1 py-2.5 text-sm font-bold rounded-lg transition-all cursor-pointer">
            Crear nuevo usuario
          </button>
        </div>

        @if (userMode() === 'existing') {
        <div class="grid gap-4 animate-in slide-in-from-left-2 duration-300">
          <label class="block">
            <span class="text-sm font-medium text-slate-700">Usuarios Disponibles</span>
            <select (change)="onUserSelect($event)"
              class="mt-1 block w-full rounded-lg border-slate-200 bg-slate-50 p-3 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500/20 outline-hidden">
              <option value="">Selecciona un usuario...</option>
              @for (user of availableUsers(); track user.id) {
              <option [value]="user.id">{{ user.email }}</option>
              }
            </select>
          </label>
        </div>
        }

        @if (userMode() === 'new') {
        <form [formGroup]="newUserForm" class="space-y-4 animate-in slide-in-from-right-2 duration-300">
          <div>
            <label class="text-sm font-medium text-slate-700">Correo electr贸nico</label>
            <input formControlName="email" type="email" placeholder="ejemplo@rentix.com"
              class="mt-1 block w-full rounded-lg border-slate-200 p-3 outline-hidden focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500/20" />
          </div>
          <div>
            <label class="text-sm font-medium text-slate-700">Contrase帽a temporal</label>
            <input formControlName="password" type="password"
              class="mt-1 block w-full rounded-lg border-slate-200 p-3 outline-hidden focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500/20" />
          </div>
        </form>
        }

        <button (click)="submitStep1()" [disabled]="isLoading()"
          class="w-full rounded-lg bg-indigo-600 px-6 py-4 font-bold text-white shadow-lg transition hover:bg-indigo-700 active:scale-[0.98] disabled:opacity-50">
          {{ isLoading() ? 'Procesando...' : 'Confirmar Responsable y Continuar' }}
        </button>
      </div>
      }

      @if (currentStep() === 2) {
      <form [formGroup]="addressForm" class="space-y-6 animate-in fade-in duration-300">
        <h2 class="text-xl font-semibold text-slate-800">2. Ubicaci贸n de la Sede</h2>
        <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
          <div class="sm:col-span-2">
            <label class="text-sm font-medium">Direcci贸n Fiscal</label>
            <input formControlName="addressLine1" type="text" placeholder="Calle, n煤mero, piso..."
              class="mt-1 block w-full rounded-lg border-slate-200 p-3 outline-hidden focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500" />
          </div>
          <div>
            <label class="text-sm font-medium">Ciudad</label>
            <input formControlName="city" type="text" class="mt-1 block w-full rounded-lg border-slate-200 p-3 outline-hidden focus:border-indigo-500" />
          </div>
          <div>
            <label class="text-sm font-medium">C贸digo Postal</label>
            <input formControlName="zipCode" type="text" class="mt-1 block w-full rounded-lg border-slate-200 p-3 outline-hidden focus:border-indigo-500" />
          </div>
        </div>
        <div class="flex gap-4">
          <button type="button" (click)="goBack()" class="w-1/3 rounded-lg border border-slate-200 px-6 py-3 font-medium text-slate-600 hover:bg-slate-50 transition-colors">Atr谩s</button>
          <button type="button" (click)="submitStep2()" class="w-2/3 rounded-lg bg-indigo-600 px-6 py-3 font-bold text-white hover:bg-indigo-700 shadow-md">Siguiente: Datos Fiscales</button>
        </div>
      </form>
      }

      @if (currentStep() === 3) {
      <form [formGroup]="fiscalForm" class="space-y-6 animate-in fade-in duration-300">
        <h2 class="text-xl font-semibold text-slate-800">3. Identidad Fiscal (FacturaE)</h2>
        <div class="space-y-4">
          <div>
            <label class="text-sm font-medium">Raz贸n Social</label>
            <input formControlName="taxName" type="text" class="mt-1 block w-full rounded-lg border-slate-200 p-3 outline-hidden focus:border-indigo-500" />
          </div>
          <div>
            <label class="text-sm font-medium">NIF / CIF</label>
            <input formControlName="taxId" type="text" placeholder="Ej: B12345678" class="mt-1 block w-full rounded-lg border-slate-200 p-3 outline-hidden focus:border-indigo-500" />
          </div>
        </div>
        <div class="flex gap-4">
          <button type="button" (click)="goBack()" class="w-1/3 rounded-lg border border-slate-200 px-6 py-3 font-medium text-slate-600 hover:bg-slate-50">Atr谩s</button>
          <button type="button" (click)="submitStep3()" class="w-2/3 rounded-lg bg-indigo-600 px-6 py-3 font-bold text-white hover:bg-indigo-700 shadow-md">Revisar y Confirmar</button>
        </div>
      </form>
      }

      @if (currentStep() === 4) {
      <div class="space-y-6 animate-in fade-in duration-300">
        <h2 class="text-xl font-semibold text-slate-800">4. Confirmaci贸n de Datos</h2>
        <div class="rounded-xl bg-slate-50 p-6 space-y-3 text-sm border border-slate-200">
          <p><strong>Owner (ID):</strong> <span class="text-indigo-600">{{ wizardService.wizardData().company?.userId }}</span></p>
          <p><strong>Raz贸n Social:</strong> {{ wizardService.wizardData().fiscal?.corporateName }}</p>
          <p><strong>Direcci贸n:</strong> {{ wizardService.wizardData().address?.addressLine1 }}, {{ wizardService.wizardData().address?.city }}</p>
        </div>
        <form [formGroup]="confirmationForm">
          <label class="flex items-center gap-3 cursor-pointer group">
            <input type="checkbox" formControlName="acceptTerms" class="h-5 w-5 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500" />
            <span class="text-sm text-slate-600 group-hover:text-slate-900 transition-colors">Confirmo que los datos fiscales son veraces y cumplen con VeriFactu.</span>
          </label>
        </form>
        <div class="flex gap-4">
          <button type="button" (click)="goBack()" class="w-1/3 rounded-lg border border-slate-200 px-6 py-3 font-medium text-slate-600 hover:bg-slate-50">Atr谩s</button>
          <button type="button" (click)="submitStep4()" [disabled]="isLoading() || confirmationForm.invalid"
            class="w-2/3 rounded-lg bg-green-600 px-6 py-4 font-bold text-white shadow-xl shadow-green-100 transition-all hover:bg-green-700 active:scale-[0.98] disabled:opacity-50">
            @if (!isLoading()) { <span> ACTIVAR PATRIMONIO</span> }
            @else { <span>Ejecutando Transacci贸n At贸mica...</span> }
          </button>
        </div>
      </div>
      }
    </div>
  </div>
</div>