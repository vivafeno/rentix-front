<div class="min-h-screen bg-slate-50 p-6 transition-colors duration-300 dark:bg-slate-950 lg:p-10">
  <div class="mx-auto max-w-6xl">

    <header class="mb-10 flex flex-col gap-2 border-l-4 border-indigo-600 pl-6">
      <h1 class="text-3xl font-black tracking-tighter text-slate-900 uppercase dark:text-white italic">
        Alta Patrimonial At√≥mica
      </h1>
      <p class="text-sm font-medium text-slate-500 italic">
        Configuraci√≥n FacturaE compatible. Validaci√≥n estricta contra el contrato OpenAPI.
      </p>
    </header>

    @if (errorMessage()) {
    <div role="alert" class="mb-8 flex items-center gap-3 rounded-xl border border-red-200 bg-red-50 p-4 text-sm text-red-800 shadow-sm animate-in fade-in slide-in-from-top-2">
      <span class="flex h-6 w-6 shrink-0 items-center justify-center rounded-full bg-red-100 font-black text-red-600">!</span>
      <p class="font-bold">{{ errorMessage() }}</p>
    </div>
    }

    <form [formGroup]="form" (ngSubmit)="submitForm()" class="grid grid-cols-1 gap-8 lg:grid-cols-12">

      <div class="space-y-8 lg:col-span-7">
        
        <section class="rounded-2xl border border-slate-200 bg-white p-8 shadow-sm dark:border-slate-800 dark:bg-slate-900">
          <div class="mb-6 flex items-center justify-between">
            <h2 class="text-xs font-black tracking-widest text-indigo-600 uppercase italic">1. Identidad y Acceso</h2>
            <div class="flex rounded-lg border border-slate-200 bg-slate-100 p-1 dark:border-slate-800 dark:bg-slate-800/50">
              <button type="button" (click)="setUserMode('existing')" 
                      [class.bg-white]="userMode() === 'existing'" 
                      class="px-4 py-1.5 text-[10px] font-black uppercase transition-all rounded-md shadow-xs">EXISTENTE</button>
              <button type="button" (click)="setUserMode('new')" 
                      [class.bg-white]="userMode() === 'new'" 
                      class="px-4 py-1.5 text-[10px] font-black uppercase transition-all rounded-md shadow-xs">NUEVO DRAFT</button>
            </div>
          </div>

          @if (userMode() === 'existing') {
          <div class="mb-6 animate-in fade-in duration-300">
            <label class="mb-1.5 block text-[10px] font-bold text-slate-400 uppercase tracking-tighter">Hidratar Usuario (Sanaci√≥n de Perfil)</label>
            <select (change)="onUserSelect($event)"
                    class="w-full rounded-lg border border-slate-200 bg-slate-50 p-3 text-sm outline-hidden focus:ring-2 focus:ring-indigo-500/10 dark:border-slate-700 dark:bg-slate-800">
              <option value="">-- Buscar Responsable --</option>
              @for (user of availableUsers(); track user.id) {
              <option [value]="user.id">{{ user.email }} ({{ user.firstName || 'Perfil Incompleto' }})</option>
              }
            </select>
          </div>
          }

          <div formGroupName="user" class="space-y-6">
            <div class="rounded-xl bg-slate-100 p-4 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-800">
              <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
                <div class="space-y-1">
                  <label class="text-[10px] font-bold text-slate-500 uppercase italic">Email (Login) *</label>
                  <input formControlName="email" type="email" class="w-full rounded-lg border border-slate-200 bg-white p-2.5 text-sm outline-none dark:bg-slate-900" />
                </div>
                <div class="space-y-1">
                  <label class="text-[10px] font-bold text-slate-500 uppercase italic">Password Inicial *</label>
                  <input formControlName="password" type="text" class="w-full rounded-lg border border-slate-200 bg-white p-2.5 text-sm font-mono outline-none dark:bg-slate-900" />
                </div>
              </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
              <div class="space-y-1">
                <label class="text-[10px] font-bold text-slate-400 uppercase tracking-tighter">Nombre *</label>
                <input formControlName="firstName" type="text" class="w-full rounded-lg border border-slate-200 bg-slate-50 p-2.5 text-sm outline-none dark:bg-slate-800" />
              </div>
              <div class="space-y-1">
                <label class="text-[10px] font-bold text-slate-400 uppercase tracking-tighter">Apellidos *</label>
                <input formControlName="lastName" type="text" class="w-full rounded-lg border border-slate-200 bg-slate-50 p-2.5 text-sm outline-none dark:bg-slate-800" />
              </div>
              <div class="col-span-2 space-y-1">
                <label class="text-[10px] font-bold text-slate-400 uppercase tracking-tighter">Tel√©fono de Contacto *</label>
                <input formControlName="phone" type="tel" placeholder="+34..." class="w-full rounded-lg border border-slate-200 bg-slate-50 p-2.5 text-sm outline-none dark:bg-slate-800" />
              </div>
            </div>
          </div>
        </section>

        <section formGroupName="fiscal" class="rounded-2xl border border-slate-200 bg-white p-8 shadow-sm dark:border-slate-800 dark:bg-slate-900">
          <h2 class="mb-6 text-xs font-black tracking-widest text-indigo-600 uppercase italic">2. Entidad Legal (FacturaE Party)</h2>
          <div class="grid grid-cols-1 gap-6 md:grid-cols-2">
            <div class="space-y-1 md:col-span-2">
              <label class="text-[10px] font-bold text-slate-400 uppercase tracking-tighter">Raz√≥n Social / Nombre Corporativo *</label>
              <input formControlName="corporateName" type="text" placeholder="Ej: Rentalin Assets S.L." class="w-full rounded-lg border border-slate-200 bg-slate-50 p-3 text-sm focus:border-indigo-500 outline-hidden dark:border-slate-700 dark:bg-slate-800" />
            </div>
            <div class="space-y-1">
              <label class="text-[10px] font-bold text-slate-400 uppercase tracking-tighter">Tax ID (NIF/CIF) *</label>
              <input formControlName="taxId" type="text" placeholder="B12345678" class="w-full rounded-lg border border-slate-200 bg-slate-50 p-3 text-sm focus:border-indigo-500 outline-hidden dark:border-slate-700 dark:bg-slate-800" />
            </div>
            <div class="space-y-1">
              <label class="text-[10px] font-bold text-slate-400 uppercase tracking-tighter">Tipo Personer√≠a</label>
              <select formControlName="personType" class="w-full rounded-lg border border-slate-200 bg-slate-50 p-3 text-sm outline-hidden dark:border-slate-700 dark:bg-slate-800">
                <option value="J">Persona Jur√≠dica (JURIDICAL)</option>
                <option value="F">Persona F√≠sica (PERSON)</option>
              </select>
            </div>
          </div>
        </section>
      </div>

      <div class="space-y-8 lg:col-span-5">
        
        <section formGroupName="address" class="rounded-2xl border border-slate-200 bg-white p-8 shadow-sm dark:border-slate-800 dark:bg-slate-900">
          <h2 class="mb-6 text-xs font-black tracking-widest text-indigo-600 uppercase italic">3. Domicilio Fiscal</h2>
          <div class="grid gap-6">
            <div class="space-y-1">
              <label class="text-[10px] font-bold text-slate-400 uppercase tracking-tighter">Direcci√≥n Principal (addressLine1) *</label>
              <input formControlName="addressLine1" type="text" placeholder="Calle Ejemplo, 12, 1¬∫A" class="w-full rounded-lg border border-slate-200 bg-slate-50 p-3 text-sm focus:border-indigo-500 outline-hidden dark:border-slate-700 dark:bg-slate-800" />
            </div>
            <div class="grid grid-cols-2 gap-4">
              <div class="space-y-1">
                <label class="text-[10px] font-bold text-slate-400 uppercase tracking-tighter">Ciudad *</label>
                <input formControlName="city" type="text" class="w-full rounded-lg border border-slate-200 bg-slate-50 p-3 text-sm outline-hidden dark:border-slate-700 dark:bg-slate-800" />
              </div>
              <div class="space-y-1">
                <label class="text-[10px] font-bold text-slate-400 uppercase tracking-tighter">C√≥digo Postal *</label>
                <input formControlName="postalCode" type="text" class="w-full rounded-lg border border-slate-200 bg-slate-50 p-3 text-sm outline-hidden dark:border-slate-700 dark:bg-slate-800" />
              </div>
            </div>
            <div class="space-y-1">
              <label class="text-[10px] font-bold text-slate-400 uppercase tracking-tighter">Provincia *</label>
              <input formControlName="province" type="text" class="w-full rounded-lg border border-slate-200 bg-slate-50 p-3 text-sm outline-hidden dark:border-slate-700 dark:bg-slate-800" />
            </div>
          </div>
        </section>

        <footer class="rounded-3xl bg-slate-900 p-8 shadow-2xl ring-1 ring-white/5">
          <div [formGroup]="form.controls.confirmation" class="mb-8 flex items-start gap-4">
            <input type="checkbox" 
                   id="certify-legal"
                   formControlName="acceptTerms" 
                   class="mt-1 h-6 w-6 shrink-0 accent-indigo-500 cursor-pointer rounded border-transparent bg-slate-800 transition-all focus:ring-2 focus:ring-indigo-500" />
            <label for="certify-legal" class="space-y-1 cursor-pointer select-none">
              <p class="text-xs font-black text-white uppercase tracking-tighter italic">Certificaci√≥n Administrativa</p>
              <p class="text-[10px] leading-relaxed text-slate-400 italic font-medium">
                Certifico que los datos coinciden con la identidad legal y autorizo la creaci√≥n at√≥mica de la infraestructura.
              </p>
            </label>
          </div>

          <button type="submit" 
                  [disabled]="isSubmitDisabled()"
                  class="group relative flex w-full items-center justify-center gap-3 overflow-hidden rounded-2xl bg-indigo-600 px-6 py-5 font-black tracking-widest text-white transition-all enabled:hover:bg-indigo-500 enabled:active:scale-[0.98] disabled:opacity-20 disabled:grayscale disabled:cursor-not-allowed shadow-xl shadow-indigo-900/40">
            @if (isLoading()) {
              <span class="animate-spin text-xl text-white/50 italic">‚Üª</span>
              <span class="italic">EJECUTANDO TRANSACCI√ìN...</span>
            } @else {
              <span>üöÄ ACTIVAR PATRIMONIO</span>
            }
          </button>
        </footer>
      </div>

    </form>
  </div>
</div>